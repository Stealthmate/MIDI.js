<!DOCTYPE html>
<html xmlns = "http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<!-- polyfill -->
	<script src="../inc/shim/Base64.js" type="text/javascript"></script>
	<script src="../inc/shim/Base64binary.js" type="text/javascript"></script>
	<script src="../inc/shim/WebAudioAPI.js" type="text/javascript"></script>
	<!-- midi.js package -->
	<script src="../js/midi/audioDetect.js" type="text/javascript"></script>
	<script src="../js/midi/gm.js" type="text/javascript"></script>
	<script src="../js/midi/loader.js" type="text/javascript"></script>
	<script src="../js/midi/plugin.audiotag.js" type="text/javascript"></script>
	<script src="../js/midi/plugin.webaudio.js" type="text/javascript"></script>
	<script src="../js/midi/plugin.webmidi.js" type="text/javascript"></script>
	<!-- utils -->
	<script src="../js/util/dom_request_xhr.js" type="text/javascript"></script>
	<script src="../js/util/dom_request_script.js" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
  <style>
    main {
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>
<body>

  <main id="app" v-on:keyup="x => playNote(x)">
    Input with 1-8. Backspace clears.
    <table>
      <tr>
        <td v-for="l in labels">{{l}}</td>
      </tr>
    </table>
    <button v-on:click="playAll()">Play</button>
  </main>
<script type="text/javascript">
  var NOTES = {
    '60': 'Low C',
    '62': 'D',
    '64': 'E',
    '65': 'F',
    '67': 'G',
    '69': 'A',
    '71': 'B',
    '72': 'High C'
  };

  var app = new Vue({
    el: '#app',
    data() {
      return { notes: [] };
    },
    computed: {
      labels() {
        let r = this.notes.map(x => NOTES[x]);
        console.log(r);
        return r;
      }
    },
    created() {
      MIDI.loadPlugin({
	      soundfontUrl: "./soundfont/",
	      instrument: "acoustic_grand_piano",
        onsuccess() {
		      MIDI.setVolume(0, 127);
        }
      });
    },
    methods: {
      onPress(k) {
        var delay = 0; // play one note every quarter second
		    var velocity = 127; // how hard the note hits
		    var note = 0; // the MIDI note
        switch(k) {
        case '1': note = 60; break;
        case '2': note = 62; break;
        case '3': note = 64; break;
        case '4': note = 65; break;
        case '5': note = 67; break;
        case '6': note = 69; break;
        case '7': note = 71; break;
        case '8': note = 72; break;
        case 'Backspace': {
          if(this.notes) this.notes.splice(this.notes.length - 1, 1);
        } break;
        default: note = undefined; break;
        }
        if(!note) return;
        this.playNote(note);
        this.notes.push(note);
      },
      playNote(note) {
		    MIDI.noteOn(0, note, 127, 0);
		    MIDI.noteOff(0, note, 0.75);
      },
      playAll() {
        for(let n in this.notes) {
          setTimeout(() => this.playNote(this.notes[n]), Number(n) * 300);
        }
      }
    }
  });
  window.addEventListener('keyup', function(e) {
    app.onPress(e.key)
  });
</script>
</body>
</html>
